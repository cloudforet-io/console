<script setup lang="ts">
import {
    computed, onMounted, reactive, watch,
} from 'vue';
import { useRoute, useRouter } from 'vue-router/composables';

import { PI, PTreeView, PSelectDropdown } from '@cloudforet/mirinae';
import type { TreeNode } from '@cloudforet/mirinae/src/data-display/tree/tree-view/type';
import type { MenuItem } from '@cloudforet/mirinae/types/controls/context-menu/type';
import type { TreeDisplayMap } from '@cloudforet/mirinae/types/data-display/tree/tree-view/type';

import type { DashboardModel } from '@/schema/dashboard/_types/dashboard-type';
import { ROLE_TYPE } from '@/schema/identity/role/constant';

import { useAppContextStore } from '@/store/app-context/app-context-store';
import { useUserStore } from '@/store/user/user-store';

import { useProperRouteLocation } from '@/common/composables/proper-route-location';
import FavoriteButton from '@/common/modules/favorites/favorite-button/FavoriteButton.vue';
import { FAVORITE_TYPE } from '@/common/modules/favorites/favorite-button/type';

import { gray } from '@/styles/colors';

import { useDashboardControlMenuItems } from '@/services/dashboards/composables/use-dashboard-control-menu-items';
import { getDashboardTreeData } from '@/services/dashboards/helpers/dashboard-tree-data-helper';
import { DASHBOARDS_ROUTE } from '@/services/dashboards/routes/route-constant';
import { useDashboardPageControlStore } from '@/services/dashboards/stores/dashboard-page-control-store';
import type { DashboardTreeDataType } from '@/services/dashboards/types/dashboard-folder-type';



interface Props {
    dashboards: DashboardModel[];
    type: 'PRIVATE' | 'PUBLIC';
}
const props = withDefaults(defineProps<Props>(), {
    dashboards: () => ([]),
    type: 'PUBLIC',
});
const route = useRoute();
const router = useRouter();
const { getProperRouteLocation } = useProperRouteLocation();
const dashboardPageControlStore = useDashboardPageControlStore();
const dashboardPageControlGetters = dashboardPageControlStore.getters;
const appContextStore = useAppContextStore();
const userStore = useUserStore();

const storeState = reactive({
    isAdminMode: computed(() => appContextStore.getters.isAdminMode),
    isWorkspaceOwner: computed(() => userStore.state.currentRoleInfo?.roleType === ROLE_TYPE.WORKSPACE_OWNER),
});
const { getControlMenuItems } = useDashboardControlMenuItems({
    isAdminMode: computed(() => storeState.isAdminMode),
    isWorkspaceOwner: computed(() => storeState.isWorkspaceOwner),
    dashboardList: computed(() => dashboardPageControlGetters.allDashboardItems),
    folderList: computed(() => dashboardPageControlGetters.allFolderItems),
});
const state = reactive({
    currentParentPathIds: [] as string[],
    currentFolderId: undefined as string|undefined,
    treeDisplayMap: {} as TreeDisplayMap,
    dashboardTreeData: computed<TreeNode<DashboardTreeDataType>[]>(() => {
        if (props.type === 'PRIVATE') {
            return getDashboardTreeData(dashboardPageControlGetters.privateFolderItems, props.dashboards);
        }
        return getDashboardTreeData(dashboardPageControlGetters.publicFolderItems, props.dashboards);
    }),
    selectedTreeId: undefined as string|undefined,
});

/* Util */
const updateTreeDisplayMap = (selectedTreeId: string) => {
    state.treeDisplayMap[selectedTreeId] = { isOpen: !state.treeDisplayMap[selectedTreeId]?.isOpen };
    state.currentFolderId = selectedTreeId;
    state.treeDisplayMap = { ...state.treeDisplayMap };
};
const init = (dashboardId?: string, _onMounted?: boolean) => {
    if (!dashboardId) {
        state.selectedTreeId = undefined;
        return;
    }
    state.selectedTreeId = dashboardId as string;
    const folderId = dashboardPageControlGetters.allDashboardItems.find((d) => d.dashboard_id === dashboardId)?.folder_id;
    if (_onMounted && folderId) {
        updateTreeDisplayMap(folderId);
    }
};

/* Event */
const handleClickTreeItem = (node: TreeNode<DashboardTreeDataType>) => {
    if (node.data.type === 'FOLDER') {
        updateTreeDisplayMap(node.data.id);
        return;
    }
    router.push(getProperRouteLocation({
        name: DASHBOARDS_ROUTE.DETAIL._NAME,
        params: {
            dashboardId: node.data.id || '',
        },
    }));
};
const handleSelectControlButton = (id: string, item: MenuItem) => {
    if (item.name === 'edit') dashboardPageControlStore.openEditNameModal(id);
    if (item.name === 'clone') dashboardPageControlStore.openCloneModal(id);
    if (item.name === 'move') dashboardPageControlStore.openMoveModal(id);
    if (item.name === 'share') dashboardPageControlStore.openShareModal(id);
    if (item.name === 'shareWithCode') dashboardPageControlStore.openShareWithCodeModal(id);
    if (item.name === 'delete') dashboardPageControlStore.openDeleteModal(id);
};

/* Watcher */
watch(() => route.params, ({ dashboardId }) => {
    init(dashboardId);
});

/* Lifecycle */
onMounted(() => {
    init(route.params.dashboardId, true);
});
</script>

<template>
    <div class="project-main-tree"
         :style="{ maxHeight: storeState.isAdminMode ? undefined : '19rem' }"
    >
        <p-tree-view :tree-data="state.dashboardTreeData"
                     :tree-display-map="state.treeDisplayMap"
                     :selected-id="state.selectedTreeId"
        >
            <template #content="{ node }">
                <div class="dashboard-menu-item-content"
                     @click="handleClickTreeItem(node)"
                >
                    <div class="contents-wrapper">
                        <p-i class="dashboard-icon"
                             :name="Array.isArray(node.children) ? 'ic_folder' : 'ic_service_dashboard'"
                             :color="gray[600]"
                             width="0.875rem"
                             height="0.875rem"
                        />
                        <span class="text">{{ node.data.name }}</span>
                    </div>
                    <div class="hover-contents-wrapper">
                        <p-select-dropdown style-type="tertiary-icon-button"
                                           button-icon="ic_ellipsis-horizontal"
                                           :menu="getControlMenuItems(node.data.id)"
                                           :selected="[]"
                                           size="sm"
                                           menu-position="left"
                                           reset-selection-on-menu-close
                                           @select="handleSelectControlButton(node.data.id, $event)"
                        />
                        <favorite-button v-if="node.data.type === 'DASHBOARD'"
                                         :item-id="node.id"
                                         :favorite-type="FAVORITE_TYPE.DASHBOARD"
                                         scale="0.8"
                                         class="favorite-button"
                        />
                    </div>
                </div>
            </template>
        </p-tree-view>
    </div>
</template>

<style scoped lang="postcss">
.project-main-tree {
    width: 100%;
    overflow-y: auto;
    .dashboard-menu-item-content {
        @apply flex items-center justify-between w-full;
        height: 2rem;
        .contents-wrapper {
            @apply flex items-center gap-1 w-full;

            .dashboard-icon {
                min-width: 0.875rem;
            }
            .text {
                @apply text-label-md text-gray-900;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }
        }

        .hover-contents-wrapper {
            display: none;
            min-width: 1.5rem;
            height: 1rem;
            align-items: center;
            gap: 0.25rem;
            padding-left: 0.5rem;
        }

        &:hover {
            .contents-wrapper {
                width: calc(100% - 3rem);
            }
            .hover-contents-wrapper {
                display: flex;
            }
        }
    }
}
</style>
