<template>
    <div class="dashboards-main-page">
        <p-heading :title="$t('DASHBOARDS.ALL_DASHBOARDS.DASHBOARDS_TITLE')"
                   use-total-count
                   :total-count="dashboardTotalCount"
        >
            <template #extra>
                <p-button v-if="!hasOnlyViewPermission && (workspaceDashboardList || projectDashboardList)"
                          icon-left="ic_plus_bold"
                          @click="handleCreateDashboard"
                >
                    {{ $t('DASHBOARDS.ALL_DASHBOARDS.CREATE') }}
                </p-button>
            </template>
        </p-heading>
        <p-divider class="dashboards-divider" />
        <dashboard-main-select-filter />
        <p-toolbox filters-visible
                   search-type="query"
                   :pagination-visible="false"
                   :page-size-changeable="false"
                   :refreshable="false"
                   :key-item-sets="queryState.keyItemSets"
                   :value-handler-map="queryState.valueHandlerMap"
                   :query-tags="queryState.queryTags"
                   @change="handleQueryChange"
                   @refresh="handleQueryChange()"
        />
        <p-data-loader :loading="loading"
                       :data="filteredDashboardStatus"
                       class="dashboard-list-wrapper"
        >
            <template #no-data>
                <p-empty
                    show-image
                    show-button
                >
                    <template #image>
                        <img alt="empty-default-image"
                             src="../../../assets/images/illust_jellyocto-with-a-telescope.svg"
                        >
                    </template>
                    <template #button>
                        <p-button icon-left="ic_plus_bold"
                                  :disabled="hasOnlyViewPermission"
                                  @click="handleCreateDashboard"
                        >
                            {{ $t('DASHBOARDS.ALL_DASHBOARDS.CREAT_NEW_DASHBOARD') }}
                        </p-button>
                    </template>
                    {{ $t('DASHBOARDS.ALL_DASHBOARDS.HELP_TEXT_CREATE') }}
                </p-empty>
            </template>
            <dashboard-main-board-list v-if="(scopeStatus !== SCOPE_TYPE.PROJECT) && workspaceDashboardList.length"
                                       :scope-type="DASHBOARD_SCOPE.DOMAIN"
                                       class="dashboard-list"
                                       :class="{'full-mode': scopeStatus === SCOPE_TYPE.DOMAIN}"
                                       :field-title="$t('DASHBOARDS.ALL_DASHBOARDS.ENTIRE_WORKSPACE')"
                                       :dashboard-list="workspaceDashboardList"
            />
            <dashboard-main-board-list v-if="scopeStatus !== SCOPE_TYPE.DOMAIN && projectDashboardList.length"
                                       :scope-type="DASHBOARD_SCOPE.PROJECT"
                                       class="dashboard-list"
                                       :class="{'full-mode': scopeStatus === SCOPE_TYPE.PROJECT}"
                                       :field-title="$t('DASHBOARDS.ALL_DASHBOARDS.SINGLE_PROJECT')"
                                       :dashboard-list="projectDashboardList"
            />
        </p-data-loader>
    </div>
</template>

<script lang="ts">
import {
    computed, onUnmounted,
    reactive, toRefs, watch,
} from 'vue';

import {
    PHeading, PDivider, PButton, PToolbox, PEmpty, PDataLoader,
} from '@spaceone/design-system';
import type {
    HandlerResponse,
    KeyDataType,
    KeyItem,
    KeyItemSet,
    ValueHandler, ValueMenuItem,
} from '@spaceone/design-system/types/inputs/search/query-search/type';
import type { ToolboxOptions } from '@spaceone/design-system/types/navigation/toolbox/type';

import { makeDistinctValueHandler } from '@cloudforet/core-lib/component-util/query-search';
import { QueryHelper } from '@cloudforet/core-lib/query';

import { SpaceRouter } from '@/router';
import { DASHBOARD_SCOPE } from '@/schema/dashboard/_constants/dashboard-constant';
import { store } from '@/store';

import { DASHBOARD_SCOPE_TYPE } from '@/store/modules/dashboard/type';

import { MENU_ID } from '@/lib/menu/config';
import { primitiveToQueryString, queryStringToString, replaceUrlQuery } from '@/lib/router-query-string';

import { useManagePermissionState } from '@/common/composables/page-manage-permission';

import DashboardMainBoardList from '@/services/dashboards/components/DashboardMainBoardList.vue';
import DashboardMainSelectFilter from '@/services/dashboards/components/DashboardMainSelectFilter.vue';
import { DASHBOARDS_ROUTE } from '@/services/dashboards/routes/route-constant';

export default {
    name: 'DashboardMainPage',
    components: {
        DashboardMainBoardList,
        DashboardMainSelectFilter,
        PDataLoader,
        PEmpty,
        PToolbox,
        PButton,
        PHeading,
        PDivider,
    },
    setup() {
        const state = reactive({
            viewersStatus: computed(() => store.state.dashboard.viewers),
            scopeStatus: computed(() => store.state.dashboard.scope),
            loading: computed(() => store.state.dashboard.loading),
            workspaceDashboardList: computed(() => (state.pagePermission[MENU_ID.WORKSPACE_DASHBOARDS] ? store.getters['dashboard/getDomainItems'] : [])),
            projectDashboardList: computed(() => (state.pagePermission[MENU_ID.PROJECT_DASHBOARDS] ? store.getters['dashboard/getProjectItems'] : [])),
            dashboardTotalCount: computed(() => {
                const domainDashboardCount = state.pagePermission[MENU_ID.WORKSPACE_DASHBOARDS] ? store.getters['dashboard/getDomainDashboardCount'] : 0;
                const projectDashboardCount = state.pagePermission[MENU_ID.PROJECT_DASHBOARDS] ? store.getters['dashboard/getProjectDashboardCount'] : 0;
                return domainDashboardCount + projectDashboardCount;
            }),
            filteredDashboardStatus: computed(() => {
                if (state.scopeStatus === DASHBOARD_SCOPE_TYPE.DOMAIN) {
                    return !!(state.workspaceDashboardList.length);
                }
                if (state.scopeStatus === DASHBOARD_SCOPE_TYPE.PROJECT) {
                    return !!(state.projectDashboardList.length);
                }
                return !!(state.dashboardTotalCount && (state.projectDashboardList.length || state.workspaceDashboardList.length));
            }),
            projectManagePermission: useManagePermissionState(MENU_ID.PROJECT_DASHBOARDS),
            workspaceManagePermission: useManagePermissionState(MENU_ID.WORKSPACE_DASHBOARDS),
            hasOnlyViewPermission: computed(() => !(state.projectManagePermission || state.workspaceManagePermission)),
            pagePermission: computed(() => store.getters['user/pagePermissionMap']),
        });

        const searchQueryHelper = new QueryHelper();
        const queryState = reactive({
            searchFilters: computed(() => store.state.dashboard.searchFilters),
            urlQueryString: computed(() => ({
                viewers: store.state.dashboard.viewers === 'ALL' ? null : primitiveToQueryString(store.state.dashboard.viewers),
                scope: store.state.dashboard.scope === 'ALL' ? null : primitiveToQueryString(store.state.dashboard.scope),
                filters: searchQueryHelper.setFilters(queryState.searchFilters).rawQueryStrings,
            })),
            keyItemSets: computed<KeyItemSet[]>(() => [{
                title: 'Properties',
                items: [
                    { name: 'label', label: 'Label' },
                ],
            }]),
            valueHandlerMap: computed(() => ({
                label: combinedDashboardLabelsAutoCompleteHandler(),
            })),
            queryTags: computed(() => searchQueryHelper.setKeyItemSets(queryState.keyItemSets).setFilters(store.state.dashboard.searchFilters).queryTags),
        });

        const handleCreateDashboard = () => { SpaceRouter.router.push({ name: DASHBOARDS_ROUTE.CREATE._NAME }); };
        const handleQueryChange = (options: ToolboxOptions = {}) => {
            if (options.queryTags !== undefined) {
                searchQueryHelper.setKeyItemSets(queryState.keyItemSets).setFiltersAsQueryTag(options.queryTags);
                store.dispatch('dashboard/setSearchFilters', searchQueryHelper.filters);
            }
        };

        /* init */
        let urlQueryStringWatcherStop;
        const init = async () => {
            const currentQuery = SpaceRouter.router.currentRoute.query;
            const useQueryValue = {
                viewers: queryStringToString(currentQuery.viewers) ?? 'ALL',
                scope: queryStringToString(currentQuery.scope) ?? 'ALL',
                filters: searchQueryHelper.setKeyItemSets(queryState.keyItemSets).setFiltersAsRawQueryString(currentQuery.filters).filters,
            };

            /* TODO: init states from url query */
            store.dispatch('dashboard/setSelectedViewers', useQueryValue.viewers);
            store.dispatch('dashboard/setSelectedScope', useQueryValue.scope);
            store.dispatch('dashboard/setSearchFilters', searchQueryHelper.filters);

            /* TODO: implementation */
            urlQueryStringWatcherStop = watch(() => queryState.urlQueryString, (urlQueryString) => {
                replaceUrlQuery(urlQueryString);
            });
        };

        const combinedDashboardLabelsAutoCompleteHandler = (): ValueHandler | undefined => {
            const projectLabelsValueHandler = makeDistinctValueHandler('dashboard.ProjectDashboard', 'labels');
            const domainLabelsValueHandler = makeDistinctValueHandler('dashboard.DomainDashboard', 'labels');
            if (!projectLabelsValueHandler && !domainLabelsValueHandler) return undefined;

            return async (inputText: string|number, keyItem: KeyItem, currentDataType?: KeyDataType, subPath?: string) => {
                const results = [] as ValueMenuItem[];
                const promises = [] as (HandlerResponse | Promise<HandlerResponse>)[];

                if (projectLabelsValueHandler) promises.push(projectLabelsValueHandler(inputText, keyItem, currentDataType, subPath));
                if (domainLabelsValueHandler) promises.push(domainLabelsValueHandler(inputText, keyItem, currentDataType, subPath));
                const responses = await Promise.allSettled(promises);

                // combine both of results and sort
                responses.forEach((res) => {
                    if (res.status === 'fulfilled') {
                        res.value.results.forEach((item) => {
                            if (results.some((d) => d.name === item.name)) return;
                            results.push(item);
                        });
                    }
                });
                results.sort((a, b) => (a.label > b.label ? 1 : -1));

                return {
                    results,
                    totalCount: results.length ?? 0,
                };
            };
        };

        (async () => {
            await init();
        })();

        onUnmounted(() => {
            // urlQueryString watcher is referencing dashboardStore which is destroyed on unmounted. so urlQueryString watcher must be destroyed on unmounted too.
            if (urlQueryStringWatcherStop) urlQueryStringWatcherStop();
        });

        return {
            ...toRefs(state),
            handleCreateDashboard,
            handleQueryChange,
            queryState,
            SCOPE_TYPE: DASHBOARD_SCOPE_TYPE,
            DASHBOARD_SCOPE,
        };
    },
};
</script>

<style lang="postcss" scoped>
.dashboards-main-page {
    @apply w-full;

    .dashboard-list-wrapper {
        @apply flex w-full;
        gap: 0.5rem;
        min-height: 16.875rem;

        .dashboard-list {
            @apply flex-grow;

            &.full-mode {
                @apply w-full;
            }
        }
    }

    @screen tablet {
        .dashboard-list-wrapper {
            display: block;
        }
    }
}
</style>
