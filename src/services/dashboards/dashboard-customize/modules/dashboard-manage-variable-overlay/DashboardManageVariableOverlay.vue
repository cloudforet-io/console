<template>
    <overlay-page-layout :visible="visible"
                         class="dashboard-manage-variable-overay"
    >
        <p-page-title :title="$t('DASHBOARDS.CUSTOMIZE.VARIABLES.TITLE')"
                      child
                      @goBack="handleClickGoBackButton"
        />
        <div class="content-wrapper">
            <p-panel-top :use-total-count="contentType === 'LIST'"
                         :total-count="1"
            >
                <template #default>
                    {{ titleSet[contentType] }}
                </template>
                <template #extra>
                    <div class="add-button-wrapper">
                        <p-button v-if="contentType === 'LIST'"
                                  icon-left="ic_plus"
                                  @click="handleChangeAddContent"
                        >
                            {{ $t('DASHBOARDS.CUSTOMIZE.VARIABLES.ADD') }}
                        </p-button>
                        <p-button v-else-if="contentType === 'EDIT'"
                                  icon-left="ic_trashcan"
                                  style-type="negative-secondary"
                                  @click="handleOpenDeleteModal"
                        >
                            {{ $t('DASHBOARDS.CUSTOMIZE.VARIABLES.DELETE') }}
                        </p-button>
                    </div>
                </template>
            </p-panel-top>
            <dashboard-manage-variable-table v-if="contentType === 'LIST'"
                                             :content-type.sync="contentType"
                                             :variables="variables"
                                             :order="order"
                                             @use-change="handleChangeVariableUse"
                                             @delete="handleOpenDeleteModal"
                                             @edit="handleChangeEditContent"
            />
            <dashboard-manage-variable-form v-else
                                            :content-type.sync="contentType"
                                            :variable-names="variableNames"
                                            :selected-variable="variables[selectedVariable]"
                                            @save="handleSaveVariable"
            />
        </div>
        <delete-modal :header-title="deleteModalState.headerTitle"
                      :visible.sync="deleteModalState.visible"
                      :loading="deleteModalState.loading"
                      @confirm="handleDeleteVariable"
        />
    </overlay-page-layout>
</template>

<script setup lang="ts">
import {
    computed, reactive, toRefs,
} from 'vue';
import type { TranslateResult } from 'vue-i18n';


import {
    PPanelTop,
    PButton,
    PPageTitle,
} from '@spaceone/design-system';
import { cloneDeep } from 'lodash';

import { SpaceRouter } from '@/router';
import { i18n } from '@/translations';

import { getUUID } from '@/lib/component-util/getUUID';

import DeleteModal from '@/common/components/modals/DeleteModal.vue';
import OverlayPageLayout from '@/common/modules/page-layouts/OverlayPageLayout.vue';

import type { DashboardVariablesSchema, DashboardVariableSchemaProperty } from '@/services/dashboards/config';
import DashboardManageVariableForm from '@/services/dashboards/dashboard-customize/modules/dashboard-manage-variable-overlay/modules/DashboardManageVariableForm.vue';
import DashboardManageVariableTable
    from '@/services/dashboards/dashboard-customize/modules/dashboard-manage-variable-overlay/modules/DashboardManageVariableTable.vue';
import type {
    OverlayStatus,
} from '@/services/dashboards/dashboard-customize/modules/dashboard-manage-variable-overlay/type';

interface Props {
    visible: boolean;
    variables: DashboardVariablesSchema['properties'];
    order: string[];
}
interface EmitFn {
    (e: 'change', variables: DashboardVariablesSchema['properties'], order?: string[]): void;
}

const props = defineProps<Props>();
const emit = defineEmits<EmitFn>();

const state = reactive({
    contentType: 'LIST' as OverlayStatus,
    titleSet: computed<Record<OverlayStatus, TranslateResult>>(() => ({
        LIST: i18n.t('DASHBOARDS.CUSTOMIZE.VARIABLES.SUB_TITLE'),
        ADD: i18n.t('DASHBOARDS.CUSTOMIZE.VARIABLES.ADD'),
        EDIT: i18n.t('DASHBOARDS.CUSTOMIZE.VARIABLES.SUB_TITLE_EDIT'),
    })),
    selectedVariable: '' as string,
    variableNames: computed<string[]>(() => {
        const properties = props.variables;
        return props.order.map((d) => properties[d].name).filter((name) => name !== properties[state.selectedVariable]?.name);
    }),
});

const deleteModalState = reactive({
    headerTitle: i18n.t('DASHBOARDS.CUSTOMIZE.VARIABLES.DELETE_TITLE'),
    visible: false,
    loading: false,
});

/* EVENT */
const handleChangeAddContent = () => {
    state.contentType = 'ADD';
};
const handleOpenDeleteModal = (propertyName: string) => {
    if (state.contentType === 'LIST') state.selectedVariable = propertyName;
    deleteModalState.visible = true;
};
const handleDeleteVariable = () => {
    const properties = cloneDeep(props.variables) as DashboardVariablesSchema['properties'];
    delete properties[state.selectedVariable];
    const changedOrder = props.order.filter((d) => d !== state.selectedVariable);
    emit('change', properties, changedOrder);

    if (state.contentType === 'EDIT') state.contentType = 'LIST';
    state.selectedVariable = '';
    deleteModalState.visible = false;
};
const handleChangeVariableUse = (name: string, value: boolean) => {
    const properties = cloneDeep(props.variables) as DashboardVariablesSchema['properties'];
    properties[name].use = value;
    emit('change', properties);
};
const handleChangeEditContent = (propertyName: string) => {
    state.selectedVariable = propertyName;
    state.contentType = 'EDIT';
};
const handleSaveVariable = (variable: DashboardVariableSchemaProperty) => {
    const properties = cloneDeep(props.variables) as DashboardVariablesSchema['properties'];
    if (state.contentType === 'ADD') {
        const variableKey = getUUID();
        properties[variableKey] = variable;
        emit('change', properties, [...props.order, variableKey]);
    } else {
        properties[state.selectedVariable] = variable;
        emit('change', properties);
    }
    state.selectedVariable = '';
    state.contentType = 'LIST';
};
const handleClickGoBackButton = () => {
    // TODO: refactor
    if (state.contentType !== 'LIST') {
        state.contentType = 'LIST';
    }
    SpaceRouter.router.go(-1);
};


const {
    contentType, titleSet, selectedVariable, variableNames,
} = toRefs(state);

</script>

<style lang="postcss" scoped>
.dashboard-manage-variable-overay {
    @apply bg-gray-100;

    .content-wrapper {
        @apply relative bg-white border border-gray-200 rounded-md ;

        .add-button-wrapper {
            @apply flex justify-end;
        }
        .list-wrapper {
            .variable-select-filter {
                @apply flex items-center;
                height: 2.875rem;
                gap: 1rem;
                padding: 0.75rem 1rem;

                .filter-header {
                    @apply text-gray-500;
                    font-size: 0.875rem;
                    line-height: 1.25;
                }
            }
        }
    }
}
</style>
